' TrustHub C4 Architecture & User Flow — PlantUML Edition
' Baseado em README.md e ARCHITECTURE.md

@startuml TrustHub_Context
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
LAYOUT_WITH_LEGEND()

Person(user, "Usuário", "Cliente que publica e acompanha feedbacks")
Person(admin, "Admin", "Gestor da empresa que responde feedbacks e acompanha métricas")
System(trusthub, "TrustHub", "Plataforma B2B de gestão de reputação")
System_Ext(googleReviews, "Google Reviews", "Fonte externa de avaliações públicas")
System_Ext(reclameAqui, "Reclame Aqui", "Plataforma de reclamações monitorada pelo TrustHub")
System_Ext(emailService, "Serviço de Email", "Envio de notificações e convites via SMTP")

Rel(user, trusthub, "Cria e acompanha feedbacks")
Rel(admin, trusthub, "Gere empresa, responde feedbacks, consome analytics")
Rel(trusthub, googleReviews, "Importa avaliações públicas (planos Intermediate e Enterprise)")
Rel(trusthub, reclameAqui, "Sincroniza reclamações (plano Enterprise)")
Rel(trusthub, emailService, "Dispara alertas críticos e comunicações")
@enduml

@startuml TrustHub_Containers
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
LAYOUT_WITH_LEGEND()

Person(user, "Usuário")
Person(admin, "Admin")

System_Boundary(trusthub, "TrustHub") {
    Container(nextApp, "Next.js App", "React + Next.js 15", "Interface web (App Router) que atende admins e usuários")
    Container(serverActions, "Server Actions & Route Handlers", "Next.js Server", "Executam regras de negócio, autenticação e integrações")
    Container(authService, "Better-Auth", "Library", "Gerencia sessões, roles e tokens")
    Container(prisma, "Prisma ORM", "Node.js", "Acesso tipado ao banco relacional")
    ContainerDb(database, "PostgreSQL", "Banco de Dados", "Armazena usuários, empresas, feedbacks, sessões e planos")
    Container(notification, "Email Worker", "Node.js + Nodemailer", "Envio de alertas críticos e convites")
    Container(externalIngest, "External Ingestion Jobs", "Node.js", "Coleta dados do Google Reviews e Reclame Aqui conforme o plano")
}

System_Ext(googleReviews, "Google Reviews", "Avaliações públicas")
System_Ext(reclameAqui, "Reclame Aqui", "Reclamações externas")
System_Ext(emailService, "SMTP Provider", "Entrega de emails transacionais")

Rel(user, nextApp, "Interage via navegador")
Rel(admin, nextApp, "Interage via navegador")
Rel(nextApp, serverActions, "Invoca ações server-side")
Rel(serverActions, authService, "Valida sessões e roles")
Rel(serverActions, prisma, "Executa queries tipadas")
Rel(prisma, database, "CRUD dados TrustHub")
Rel(serverActions, notification, "Solicita envio de emails")
Rel(notification, emailService, "SMTP")
Rel(externalIngest, googleReviews, "Importa avaliações públicas")
Rel(externalIngest, reclameAqui, "Coleta reclamações")
Rel(externalIngest, prisma, "Persiste dados integrados")
@enduml

@startuml TrustHub_Components
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml
LAYOUT_WITH_LEGEND()

Container(nextApp, "Next.js App", "React")

Component(appRouter, "App Router Pages & Layouts", "Server Components", "Entrega páginas públicas e autenticadas")
Component(uiComponents, "Shared UI Components", "React", "Componentes visuais reutilizáveis (Shadcn + internos)")
Component(forms, "Form Hooks", "React Hook Form + Zod", "Validação e submissão de formulários de feedback e login")
Component(zustandStores, "Zustand Stores", "State Management", "Gerencia estado client-side (ex.: sidebar, filtros)")
Component(authClient, "Better-Auth Client", "Browser/Server", "Consome sessão autenticada e refresh tokens")
Component(apiActions, "Server Actions", "Next.js", "Executa lógica de domínio para feedbacks, empresas e planos")
Component(prismaAdapter, "Prisma Adapter", "Server Utility", "Wrapper que expõe operações tipadas do banco")

Rel(appRouter, uiComponents, "Renderiza UI compartilhada")
Rel(appRouter, forms, "Incorpora validação e submissão")
Rel(forms, apiActions, "Submete dados com validação")
Rel(appRouter, zustandStores, "Controla estado de interface")
Rel(appRouter, authClient, "Controla rotas protegidas")
Rel(apiActions, prismaAdapter, "Usa Prisma via server-side")
@enduml

@startuml TrustHub_Dynamic
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Dynamic.puml
LAYOUT_WITH_LEGEND()

Person(user, "Usuário")
Person(admin, "Admin")
Container(nextApp, "Next.js App")
Container(serverActions, "Server Actions")
Container(prisma, "Prisma ORM")
ContainerDb(database, "PostgreSQL")
Container(externalIngest, "External Ingestion Jobs")

Rel(user, nextApp, "1. Explora empresas públicas e envia feedback")
Rel(nextApp, serverActions, "2. Valida dados com Zod e envia ação server-side")
Rel(serverActions, prisma, "3. Persiste feedback e histórico")
Rel(prisma, database, "4. Salva feedback vinculado à empresa")
Rel(admin, nextApp, "5. Admin acessa dashboard filtrado pela própria empresa")
Rel(nextApp, serverActions, "6. Server Actions retornam feedbacks conforme plano")
Rel(serverActions, prisma, "7. Consulta feedbacks + métricas")
Rel(prisma, database, "8. Retorna dados autorizados")
Rel(externalIngest, prisma, "9. Jobs importam avaliações externas (quando plano >= Intermediate)")
Rel(prisma, database, "10. Atualiza tabelas de fontes externas")
Rel(serverActions, nextApp, "11. Admin recebe alertas/sugestões conforme plano")
@enduml

' Narrativa do Fluxo do Usuário
' 1. Descoberta e Login — Autenticação via Better-Auth gerando tokens e vinculando sessão ao contexto correto.
' 2. Exploração e Feedback (Usuário) — Catálogo público, formulários com React Hook Form + Zod, persistência via Server Actions e Prisma.
' 3. Monitoramento e Resposta (Admin) — Dashboard filtrado por companyId, respostas e atribuições com métricas.
' 4. Integração Multicanal por Plano — Jobs coletam Google Reviews (Intermediate) e Reclame Aqui (Enterprise).
' 5. Alertas e Insights — Nodemailer dispara notificações quando feedbacks críticos ou padrões relevantes são detectados.
